<% layout("/layouts/boilerplate.ejs") %>

  <body>
    <!DOCTYPE html>
    <html lang="en">

    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Machinery Details | FarmLink</title>


      <style>
        body {
          background-color: #f8f9fa;
        }
        
      </style>
    </head>

    <body>
      <div class="container pt-5 col-6">
        <a href="/home/listings" class="back-link mb-4 d-inline-block">&larr; Back to Listings</a>

        <div class="details-card">
          <!-- Image -->
          <img src="<%= listing.imageUrl.url %>" alt="<%= listing.title %>"
            class="details-image"
            onerror="this.onerror=null; this.src='https://placehold.co/800x400/4CAF50/FFFFFF?text=<%=listing.title%>';" />

                            <!-- Content of the machinary-->
                  <div class="details-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h2 class="details-title"><%= listing.title %></h2>
                      <span class="price-badge">
                        &#8377 <%= listing.pricePerDay.toLocaleString("en-IN") %> /day
                      </span>
                    </div>

                    <p class="details-meta">
                      <b>Location:</b> <%= listing.location %> |
                      <b>Community:</b> <%= listing.community %> |
                      <b>Type:</b> <%= listing.type %>
                    </p>

                    <hr />

                    <h5>Description</h5>
                    <p><%= listing.description %></p>

                    <h5 class="mt-4">Features</h5>
                    <ul class="feature-list">
                      <li>75 HP engine</li>
                      <li>Hydraulic power steering</li>
                      <li>4-wheel drive</li>
                      <li>Excellent fuel economy</li>
                      <li>Suitable for ploughing and harvesting</li>
                    </ul>

                    <!-- Owner Details Section -->
                    <div class="card mt-2 shadow-sm border-0 owner-card">
                      <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                          <h5 class="fw-bold text-success mb-1">
                            <i class="bi bi-person-circle"></i>
                            <%=listing.owner.username %>
                          </h5>
                          <p class="mb-2 text-muted">
                            <b>Status:</b>
                            <% if (listing.isAvailable) { %>
                              <span class="badge bg-success">Available</span>
                            <% } else { %>
                              <span class="badge bg-secondary">Not Available</span>
                            <% } %>
                          </p>
                          <p class="mb-0 text-muted"><b>Joined on :</b> <%= listing.owner.joinedAt.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) %></p>
                        </div>

                        <div class="mt-3 mt-md-0 " >
                          <!-- WhatsApp Message Button -->
                          <a 
                            href="https://wa.me/<%=listing.owner.phone%>" 
                            target="_blank" 
                            class="btn btn-outline-primary btn-sm me-2 "
                          >
                            <i class="bi bi-chat-dots"></i> Message Owner
                          </a>
                        
                          <!-- Direct Call Button -->
                          <a 
                            href="tel:+91<%=listing.owner.phone%>" 
                            class="btn btn-success btn-sm me-2 "
                          >
                            <i class="bi bi-telephone "></i> Contact Owner
                          </a>
                        </div>
                        
                        </div>
                    <!-- Owner Options -->
                    
                    <div class="owner-btn mt-4 d-flex">
                      <% if(currUser && currUser._id.equals(listing.owner._id)) { %>
                        <form action="/home/listings/<%= listing._id %>/edit">
                          <button class="btn btn-outline-success me-3">
                            <i class="bi bi-pencil"></i> Edit
                          </button>
                        </form>
  
                        <form method="post" action="/home/listings/<%= listing._id %>?_method=DELETE">
                          <button class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> Delete
                          </button>
                        </form>
                        <% } %>
                      
                    </div>
                  </div>

        </div>
      </div>
    </div>
      <hr>

      <!------------------------------------------- Review Section--------------------------------------- -->
      <div class="container mb-5">
        <div class="card shadow-sm border-0 p-4 ">
          <h4 class="mb-4 text-success fw-bold">ðŸŒ¾ Reviews & Feedback</h4>

          <!-- Review Form -->
           <% if(currUser) { %>
              <form action="/home/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">
                
                <div class="mb-4">
                  <label for="rating" class="form-label fw-semibold">Rating (1â€“5)</label>
                
                  <div class="star-rating d-flex flex-row justify-content-end">
                    <input type="radio" id="star5" name="review[rating]" value="5" required/>
                    <label for="star5" class="bi bi-star-fill"></label>
                
                    <input type="radio" id="star4" name="review[rating]" value="4"/>
                    <label for="star4" class="bi bi-star-fill"></label>
                
                    <input type="radio" id="star3" name="review[rating]" value="3"/>
                    <label for="star3" class="bi bi-star-fill"></label>
                
                    <input type="radio" id="star2" name="review[rating]" value="2"/>
                    <label for="star2" class="bi bi-star-fill"></label>
                
                    <input type="radio" id="star1" name="review[rating]" value="1"/>
                    <label for="star1" class="bi bi-star-fill"></label>
                  </div>
                </div>
                
                <style>
                /* Star rating styling */
                .star-rating {
                  direction: rtl;
                  font-size: 1.8rem;
                }
                
                .star-rating input[type="radio"] {
                  display: none;
                }
                
                .star-rating label {
                  color: #ccc;
                  cursor: pointer;
                  transition: color 0.2s ease-in-out;
                }
                
                .star-rating input[type="radio"]:checked ~ label {
                  color: #ffc107;
                }
                
                .star-rating label:hover,
                .star-rating label:hover ~ label {
                  color: #ffdb58;
                }
                </style>
    
                <div class="mb-3">
                  <label for="comment" class="form-label fw-semibold">Your Review</label>
                  <textarea id="comment" name="review[comment]" class="form-control" rows="3"
                    placeholder="Share your experience with this machinery..." class="form-control" required></textarea>
                  <div class="invalid-feedback">Please add some comment for review.</div>
                </div>
    
                <button type="submit" class="btn btn-success px-4 fw-semibold">
                  Submit Review
                </button>
              </form>
           <% } %>
          
        </div>
      
        <br>
        <!-- submitted reviews -->
        <% if (listing.reviews && listing.reviews.length> 0) { %>

          <div class="list-group shadow-sm rounded">
            <h5><b>All Reviews</b></h5>
            
            <% listing.reviews.forEach(review=> { %>
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-1 fw-semibold text-success"><i class="bi bi-person-circle"></i>
                    <%= review.author.username %>
                  </h6>
                  <span class="badge bg-warning text-dark">
                    <i class="bi bi-star-fill"></i>
                    <%= review.rating %>/5
                  </span>
                </div>
                <p class="mb-1 mt-2">
                  <%= review.comment %>
                </p>
                <small class="text-muted">Posted on <%= new Date(review.createdAt).toLocaleDateString() %></small>

               
                <% if (currUser && review.author && currUser._id.equals(review.author._id)) { %>
                          <!-- Delete Button -->
                          <form method="post" action="/home/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=delete"
                            class="mt-3 text-end">
                         
                            <button class="btn btn-outline-danger btn-sm">
                              <i class="bi bi-trash3"></i> Delete
                            </button>
    
                          </form>
                     <% } %>

              </div>
              <% }) %>
          </div>
          <% } else { %>
            <div class="alert alert-light border-start border-success shadow-sm" role="alert">
              <i class="bi bi-emoji-smile text-success"></i> No reviews yet. Be the first to share your experience!
            </div>
            <% } %>

      </div>
</div>


    </body>

    </html>


    <!-- <br><br>
    <a href="/home/listings/<%=listing._id%>/edit">Edit</a>
    <br><br>
    <form method="post" action="/home/listings/<%=listing._id%>?_method=Delete">
        <button>Delete</button>
    </form> -->
  </body>